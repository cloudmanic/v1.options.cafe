version: v1.0
name: app.options.cafe
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build app
    task:
      prologue:
        commands:
          - export "GOPATH=$(go env GOPATH)"
          - export "GOBIN=$(go env GOPATH)/bin"
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/github.com/cloudmanic/${SEMAPHORE_PROJECT_NAME}"
          - export "PATH=$GOBIN:${PATH}"
          - mkdir -vp "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"
          - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
      jobs:
      - name: Get app code and packages
        commands:
          - checkout
          - sem-version go 1.12
          - echo $GOPATH $GOBIN $SEMAPHORE_GIT_DIR
          - pwd
          - cd $SEMAPHORE_GIT_DIR/backend
          # - dep ensure
          # - rm .env
          # - go test -v ./...
          - go build -ldflags="-s -w" -o builds/app.options.cafe
