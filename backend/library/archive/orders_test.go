package archive

import (
	"encoding/json"
	"testing"

	"github.com/cloudmanic/app.options.cafe/backend/brokers/types"
	"github.com/cloudmanic/app.options.cafe/backend/models"
	"github.com/nbio/st"
)

//
// Test - Store orders.
//
func TestStoreOrders01(t *testing.T) {

	// Start the db connection.
	db, _ := models.NewDB()

	// Truncate the tables we are going to populate.
	db.Exec("TRUNCATE TABLE orders;")
	db.Exec("TRUNCATE TABLE trade_groups;")
	db.Exec("TRUNCATE TABLE positions;")

	// Build test user
	db.Exec("TRUNCATE TABLE users;")
	db.Create(&models.User{FirstName: "Rob", LastName: "Tester", Email: "spicer+robtester@options.cafe", Status: "Active"})

	// Test Broker
	db.Exec("TRUNCATE TABLE brokers;")
	db.Create(&models.Broker{Name: "Tradier", UserId: 1})

	// BrokerAccounts
	db.Exec("TRUNCATE TABLE broker_accounts;")
	db.Create(&models.BrokerAccount{UserId: 1, BrokerId: 1, Name: "Test Account 1", AccountNumber: "VA47424088", StockCommission: 3.95, StockMin: 0.00, OptionCommission: 0.35, OptionSingleMin: 5.00, OptionMultiLegMin: 7.00, OptionBase: 0.00})
	db.Create(&models.BrokerAccount{UserId: 1, BrokerId: 1, Name: "Test Account 2", AccountNumber: "VA39864502", StockCommission: 3.95, StockMin: 0.00, OptionCommission: 0.35, OptionSingleMin: 5.00, OptionMultiLegMin: 7.00, OptionBase: 0.00})

	// Build sample orders
	orderJson := `[{"id":"234352","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"SPY","side":"buy","quantity":2,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":0.84,"exec_quantity":2,"last_fill_price":0,"last_fill_quantity":2,"remaining_quantity":0,"create_date":"2018-09-14T16:58:41.945Z","transaction_date":"2018-09-14T16:58:52.063Z","class":"multileg","option_symbol":"","num_legs":2,"legs":[{"type":"market","symbol":"SPY","option_symbol":"SPY181026P00270000","side":"buy_to_open","quantity":2,"status":"filled","duration":"day","avg_fill_price":0.71,"exec_quantity":2,"last_fill_price":0.71,"last_fill_quantity":2,"remaining_quantity":0,"create_date":"2018-09-14T16:58:41.945Z","transaction_date":"2018-09-14T16:58:52.062Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181026P00215000","side":"buy_to_open","quantity":2,"status":"filled","duration":"day","avg_fill_price":0.13,"exec_quantity":2,"last_fill_price":0.13,"last_fill_quantity":2,"remaining_quantity":0,"create_date":"2018-09-14T16:58:41.945Z","transaction_date":"2018-09-14T16:58:52.063Z"}]},{"id":"234358","account_id":"VA47424088","broker_account_id":0,"type":"credit","symbol":"FB","side":"buy","quantity":10,"status":"expired","duration":"day","price":1,"stop":0,"avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-09-14T17:36:22.093Z","transaction_date":"2018-09-14T20:40:00.135Z","class":"multileg","option_symbol":"","num_legs":2,"legs":[{"type":"credit","symbol":"FB","option_symbol":"FB181102P00155000","side":"buy_to_open","quantity":10,"status":"expired","duration":"day","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-09-14T17:36:22.093Z","transaction_date":"2018-09-14T20:40:00.135Z"},{"type":"credit","symbol":"FB","option_symbol":"FB181102P00160000","side":"sell_to_open","quantity":10,"status":"expired","duration":"day","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-09-14T17:36:22.093Z","transaction_date":"2018-09-14T20:40:00.135Z"}]},{"id":"234361","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"HD","side":"buy","quantity":12,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":-1.04,"exec_quantity":12,"last_fill_price":0,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:37:40.619Z","transaction_date":"2018-09-14T17:37:50.708Z","class":"multileg","option_symbol":"","num_legs":2,"legs":[{"type":"market","symbol":"HD","option_symbol":"HD181019P00190000","side":"buy_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":0.5,"exec_quantity":12,"last_fill_price":0.5,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:37:40.619Z","transaction_date":"2018-09-14T17:37:50.708Z"},{"type":"market","symbol":"HD","option_symbol":"HD181019P00200000","side":"sell_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":1.54,"exec_quantity":12,"last_fill_price":1.54,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:37:40.619Z","transaction_date":"2018-09-14T17:37:50.708Z"}]},{"id":"234364","account_id":"VA47424088","broker_account_id":0,"type":"debit","symbol":"HD","side":"buy","quantity":12,"status":"filled","duration":"gtc","price":0.03,"stop":0,"avg_fill_price":1.11,"exec_quantity":12,"last_fill_price":0,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:38:20.604Z","transaction_date":"2018-09-14T17:38:30.692Z","class":"multileg","option_symbol":"","num_legs":2,"legs":[{"type":"debit","symbol":"HD","option_symbol":"HD181019P00190000","side":"sell_to_close","quantity":12,"status":"filled","duration":"gtc","avg_fill_price":0.48,"exec_quantity":12,"last_fill_price":0.48,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:38:20.604Z","transaction_date":"2018-09-14T17:38:30.692Z"},{"type":"debit","symbol":"HD","option_symbol":"HD181019P00200000","side":"buy_to_close","quantity":12,"status":"filled","duration":"gtc","avg_fill_price":1.59,"exec_quantity":12,"last_fill_price":1.59,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T17:38:20.604Z","transaction_date":"2018-09-14T17:38:30.692Z"}]},{"id":"234369","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"SPY","side":"buy","quantity":12,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":4.16,"exec_quantity":12,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-09-14T18:00:41.066Z","transaction_date":"2018-09-14T18:09:46.674Z","class":"multileg","option_symbol":"","num_legs":4,"legs":[{"type":"market","symbol":"SPY","option_symbol":"SPY181015P00275000","side":"buy_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":4.75,"exec_quantity":10,"last_fill_price":4.75,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-09-14T18:00:41.066Z","transaction_date":"2018-09-14T18:09:46.674Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181015P00280000","side":"sell_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":5.75,"exec_quantity":10,"last_fill_price":5.75,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-09-14T18:00:41.066Z","transaction_date":"2018-09-14T18:09:46.674Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181015P00300000","side":"sell_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":10.67,"exec_quantity":12,"last_fill_price":10.67,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T18:00:41.066Z","transaction_date":"2018-09-14T18:00:51.374Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181015P00305000","side":"buy_to_open","quantity":12,"status":"filled","duration":"day","avg_fill_price":15.83,"exec_quantity":12,"last_fill_price":15.83,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-14T18:00:41.066Z","transaction_date":"2018-09-14T18:00:51.375Z"}]},{"id":"234622","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"T","side":"buy","quantity":12,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":33.37,"exec_quantity":12,"last_fill_price":33.37,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-09-20T02:14:53.695Z","transaction_date":"2018-09-20T13:45:05.487Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"234623","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"HD","side":"sell_short","quantity":5,"status":"filled","duration":"gtc","price":0,"stop":0,"avg_fill_price":211.68,"exec_quantity":5,"last_fill_price":211.68,"last_fill_quantity":5,"remaining_quantity":0,"create_date":"2018-09-20T02:16:03.312Z","transaction_date":"2018-09-20T13:45:05.558Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"234624","account_id":"VA47424088","broker_account_id":0,"type":"limit","symbol":"SBUX","side":"buy","quantity":4,"status":"filled","duration":"gtc","price":56,"stop":0,"avg_fill_price":55.635,"exec_quantity":4,"last_fill_price":55.635,"last_fill_quantity":4,"remaining_quantity":0,"create_date":"2018-09-20T02:52:13.916Z","transaction_date":"2018-09-20T13:45:05.589Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"234625","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"IBM","side":"sell_short","quantity":10,"status":"filled","duration":"gtc","price":0,"stop":0,"avg_fill_price":149.58,"exec_quantity":10,"last_fill_price":149.58,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-09-20T03:10:44.371Z","transaction_date":"2018-09-20T13:45:05.620Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"234669","account_id":"VA47424088","broker_account_id":0,"type":"stop_limit","symbol":"T","side":"sell","quantity":1,"status":"open","duration":"gtc","price":35,"stop":0,"avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":1,"create_date":"2018-09-21T00:02:45.403Z","transaction_date":"2018-09-21T12:30:01.172Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"234670","account_id":"VA47424088","broker_account_id":0,"type":"limit","symbol":"HD","side":"buy_to_cover","quantity":5,"status":"filled","duration":"gtc","price":200,"stop":0,"avg_fill_price":200,"exec_quantity":5,"last_fill_price":200,"last_fill_quantity":5,"remaining_quantity":0,"create_date":"2018-09-21T00:07:26.487Z","transaction_date":"2018-10-04T14:12:33.240Z","class":"equity","option_symbol":"","num_legs":0,"legs":null},{"id":"238190","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"SPY","side":"buy","quantity":10,"status":"open","duration":"gtc","price":0,"stop":0,"avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":10,"create_date":"2018-10-26T06:56:02.491Z","transaction_date":"2018-10-26T12:30:02.237Z","class":"multileg","option_symbol":"","num_legs":4,"legs":[{"type":"market","symbol":"SPY","option_symbol":"SPY181130P00260000","side":"buy_to_open","quantity":10,"status":"open","duration":"gtc","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":10,"create_date":"2018-10-26T06:56:02.491Z","transaction_date":"2018-10-26T12:30:02.147Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130P00262000","side":"sell_to_open","quantity":10,"status":"open","duration":"gtc","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":10,"create_date":"2018-10-26T06:56:02.491Z","transaction_date":"2018-10-26T12:30:02.179Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130C00270000","side":"sell_to_open","quantity":10,"status":"open","duration":"gtc","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":10,"create_date":"2018-10-26T06:56:02.491Z","transaction_date":"2018-10-26T12:30:02.208Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130C00272000","side":"buy_to_open","quantity":10,"status":"open","duration":"gtc","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":10,"create_date":"2018-10-26T06:56:02.491Z","transaction_date":"2018-10-26T12:30:02.237Z"}]},{"id":"238195","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"FB","side":"buy","quantity":11,"status":"expired","duration":"day","price":0,"stop":0,"avg_fill_price":3.6,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-10-26T07:13:33.414Z","transaction_date":"2018-10-26T20:40:00.022Z","class":"multileg","option_symbol":"","num_legs":4,"legs":[{"type":"market","symbol":"FB","option_symbol":"FB181207P00141000","side":"sell_to_open","quantity":11,"status":"expired","duration":"day","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-10-26T07:13:33.414Z","transaction_date":"2018-10-26T20:40:00.022Z"},{"type":"market","symbol":"FB","option_symbol":"FB181207P00143000","side":"buy_to_open","quantity":11,"status":"expired","duration":"day","avg_fill_price":0,"exec_quantity":0,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-10-26T07:13:33.414Z","transaction_date":"2018-10-26T20:40:00.022Z"},{"type":"market","symbol":"FB","option_symbol":"FB181207C00155000","side":"buy_to_open","quantity":11,"status":"expired","duration":"day","avg_fill_price":7,"exec_quantity":11,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-10-26T07:13:33.414Z","transaction_date":"2018-10-26T20:40:00.022Z"},{"type":"market","symbol":"FB","option_symbol":"FB181207C00157500","side":"sell_to_open","quantity":11,"status":"expired","duration":"day","avg_fill_price":3.4,"exec_quantity":11,"last_fill_price":0,"last_fill_quantity":0,"remaining_quantity":0,"create_date":"2018-10-26T07:13:33.414Z","transaction_date":"2018-10-26T20:40:00.022Z"}]},{"id":"238200","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"IWM","side":"buy","quantity":12,"status":"filled","duration":"gtc","price":0,"stop":0,"avg_fill_price":1.64,"exec_quantity":12,"last_fill_price":0,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-10-26T07:26:44.021Z","transaction_date":"2018-10-26T13:45:17.059Z","class":"multileg","option_symbol":"","num_legs":2,"legs":[{"type":"market","symbol":"IWM","option_symbol":"IWM181123C00152000","side":"sell_to_open","quantity":12,"status":"filled","duration":"gtc","avg_fill_price":2.17,"exec_quantity":12,"last_fill_price":2.17,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-10-26T07:26:44.021Z","transaction_date":"2018-10-26T13:45:17.057Z"},{"type":"market","symbol":"IWM","option_symbol":"IWM181231C00152000","side":"buy_to_open","quantity":12,"status":"filled","duration":"gtc","avg_fill_price":3.81,"exec_quantity":12,"last_fill_price":3.81,"last_fill_quantity":12,"remaining_quantity":0,"create_date":"2018-10-26T07:26:44.021Z","transaction_date":"2018-10-26T13:45:17.059Z"}]},{"id":"238242","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"SPY","side":"buy","quantity":10,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":-0.93,"exec_quantity":10,"last_fill_price":0,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-10-26T16:13:55.083Z","transaction_date":"2018-10-26T16:14:05.218Z","class":"multileg","option_symbol":"","num_legs":4,"legs":[{"type":"market","symbol":"SPY","option_symbol":"SPY181130P00253000","side":"buy_to_open","quantity":10,"status":"filled","duration":"day","avg_fill_price":3.13,"exec_quantity":10,"last_fill_price":3.13,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-10-26T16:13:55.083Z","transaction_date":"2018-10-26T16:14:05.217Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130P00255000","side":"sell_to_open","quantity":10,"status":"filled","duration":"day","avg_fill_price":3.48,"exec_quantity":10,"last_fill_price":3.48,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-10-26T16:13:55.083Z","transaction_date":"2018-10-26T16:14:05.218Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130C00275000","side":"sell_to_open","quantity":10,"status":"filled","duration":"day","avg_fill_price":2.64,"exec_quantity":10,"last_fill_price":2.64,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-10-26T16:13:55.083Z","transaction_date":"2018-10-26T16:14:05.218Z"},{"type":"market","symbol":"SPY","option_symbol":"SPY181130C00277000","side":"buy_to_open","quantity":10,"status":"filled","duration":"day","avg_fill_price":2.06,"exec_quantity":10,"last_fill_price":2.06,"last_fill_quantity":10,"remaining_quantity":0,"create_date":"2018-10-26T16:13:55.083Z","transaction_date":"2018-10-26T16:14:05.218Z"}]},{"id":"238327","account_id":"VA47424088","broker_account_id":0,"type":"market","symbol":"FB","side":"buy","quantity":11,"status":"filled","duration":"day","price":0,"stop":0,"avg_fill_price":2.49,"exec_quantity":11,"last_fill_price":0,"last_fill_quantity":11,"remaining_quantity":0,"create_date":"2018-10-26T19:17:49.678Z","transaction_date":"2018-10-26T19:17:59.831Z","class":"multileg","option_symbol":"","num_legs":4,"legs":[{"type":"market","symbol":"FB","option_symbol":"FB181221P00125000","side":"sell_to_open","quantity":11,"status":"filled","duration":"day","avg_fill_price":2.59,"exec_quantity":11,"last_fill_price":2.59,"last_fill_quantity":11,"remaining_quantity":0,"create_date":"2018-10-26T19:17:49.678Z","transaction_date":"2018-10-26T19:17:59.830Z"},{"type":"market","symbol":"FB","option_symbol":"FB181221P00130000","side":"buy_to_open","quantity":11,"status":"filled","duration":"day","avg_fill_price":3.8,"exec_quantity":11,"last_fill_price":3.8,"last_fill_quantity":11,"remaining_quantity":0,"create_date":"2018-10-26T19:17:49.678Z","transaction_date":"2018-10-26T19:17:59.830Z"},{"type":"market","symbol":"FB","option_symbol":"FB181221C00160000","side":"buy_to_open","quantity":11,"status":"filled","duration":"day","avg_fill_price":3.95,"exec_quantity":11,"last_fill_price":3.95,"last_fill_quantity":11,"remaining_quantity":0,"create_date":"2018-10-26T19:17:49.678Z","transaction_date":"2018-10-26T19:17:59.830Z"},{"type":"market","symbol":"FB","option_symbol":"FB181221C00165000","side":"sell_to_open","quantity":11,"status":"filled","duration":"day","avg_fill_price":2.67,"exec_quantity":11,"last_fill_price":2.67,"last_fill_quantity":11,"remaining_quantity":0,"create_date":"2018-10-26T19:17:49.678Z","transaction_date":"2018-10-26T19:17:59.831Z"}]}]`
	orders := []types.Order{}
	json.Unmarshal([]byte(orderJson), &orders)

	err := StoreOrders(db, orders, uint(1), uint(1))
	st.Expect(t, err, nil)

}

/* End File */
