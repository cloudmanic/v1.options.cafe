//
// Date: 2/18/2018
// Author(s): Spicer Matthews (spicer@options.cafe)
// Copyright: 2018 Cloudmanic Labs, LLC. All rights reserved.
//

package models

import (
	"testing"

	env "github.com/jpfuentes2/go-env"
	"github.com/nbio/st"
)

//
// Test - Get Orders By User Class Status Reviewed
//
func TestGetOrdersByUserClassStatusReviewed01(t *testing.T) {

	// Load config file.
	env.ReadEnv("../.env")

	// Start the db connection.
	db, dbName, _ := NewTestDB("")
	defer TestingTearDown(db, dbName)

	// Orders
	db.Exec(`INSERT INTO orders (id, user_id, created_at, updated_at, broker_account_id, broker_ref, broker_account_ref, type, symbol_id, option_symbol_id, side, qty, status, duration, price, avg_fill_price, exec_quantity, last_fill_price, last_fill_quantity, remaining_quantity, create_date, transaction_date, class, num_legs, position_reviewed) VALUES
	(1,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'734801','ABC123ZY','limit',1,11,'buy_to_open',1,'filled','day',2.40,2.39,1.00,2.39,1.00,0.00,'2018-01-16 11:54:50','2018-01-16 11:54:51','option',0,'No'),
	(2,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'735196','ABC123ZY','limit',1,11,'sell_to_close',-1,'filled','gtc',3.39,3.62,1.00,3.62,1.00,0.00,'2018-01-16 15:29:51','2018-02-05 06:30:03','option',0,'No'),
	(3,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'767256','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.24,-0.24,9.00,0.00,1.00,0.00,'2018-01-30 09:20:25','2018-01-30 09:45:11','multileg',2,'No'),
	(4,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'770154','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.24,-0.24,9.00,0.00,9.00,0.00,'2018-01-31 09:39:20','2018-01-31 11:21:38','multileg',2,'No'),
	(5,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'772977','ABC123ZY','debit',1,0,'buy',9,'filled','gtc',0.80,0.72,9.00,0.00,9.00,0.00,'2018-02-01 09:30:04','2018-02-05 11:57:31','multileg',2,'No'),
	(6,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'773020','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.21,-0.21,9.00,0.00,9.00,0.00,'2018-02-01 09:40:44','2018-02-01 10:42:33','multileg',2,'No'),
	(7,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'775404','ABC123ZY','debit',1,0,'buy',18,'filled','gtc',0.80,0.69,18.00,0.00,18.00,0.00,'2018-02-02 07:27:02','2018-02-05 11:58:57','multileg',2,'No'),
	(8,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'775734','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.23,-0.23,9.00,0.00,9.00,0.00,'2018-02-02 08:07:00','2018-02-02 08:19:15','multileg',2,'No'),
	(9,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'780197','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.25,-0.25,9.00,0.00,9.00,0.00,'2018-02-05 08:01:06','2018-02-05 08:17:18','multileg',2,'No'),
	(10,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',2,'781119','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.22,-0.22,9.00,0.00,9.00,0.00,'2018-02-05 10:40:10','2018-02-05 11:26:06','multileg',2,'No'),
	(11,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'781816','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.35,-0.35,9.00,0.00,1.00,0.00,'2018-02-05 12:11:47','2018-02-05 12:14:14','multileg',2,'No'),
	(12,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'784720','ABC123ZY','limit',10,12,'buy_to_open',2,'filled','day',6.60,6.45,2.00,6.45,1.00,0.00,'2018-02-06 09:36:01','2018-02-06 09:36:58','option',0,'No'),
	(13,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'784730','ABC123ZY','credit',10,0,'buy',2,'filled','day',1.20,-1.44,2.00,0.00,2.00,0.00,'2018-02-06 09:39:06','2018-02-06 09:39:06','multileg',2,'No'),
	(14,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'790726','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.31,-0.31,9.00,0.00,9.00,0.00,'2018-02-08 09:53:10','2018-02-08 09:54:24','multileg',2,'No'),
	(15,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'790833','ABC123ZY','debit',1,0,'buy',9,'filled','gtc',0.03,0.03,9.00,0.00,9.00,0.00,'2018-02-08 10:09:37','2018-02-16 09:35:13','multileg',2,'No'),
	(16,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'791126','ABC123ZY','limit',10,13,'buy_to_open',2,'filled','day',5.00,5.00,2.00,5.00,2.00,0.00,'2018-02-08 11:05:07','2018-02-08 12:35:55','option',0,'No'),
	(17,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'793756','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.28,-0.28,9.00,0.00,9.00,0.00,'2018-02-09 09:06:50','2018-02-09 09:08:48','multileg',2,'No'),
	(18,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'793804','ABC123ZY','limit',10,13,'sell_to_close',-2,'filled','gtc',9.00,9.00,2.00,9.00,2.00,0.00,'2018-02-09 09:11:52','2018-02-16 10:35:53','option',0,'No'),
	(19,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'797557','ABC123ZY','debit',1,0,'buy',9,'filled','gtc',0.03,0.03,9.00,0.00,9.00,0.00,'2018-02-12 09:09:44','2018-02-14 06:35:46','multileg',2,'No'),
	(20,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',2,'802693','ABC123ZY','credit',1,0,'buy',9,'filled','day',0.29,-0.29,9.00,0.00,9.00,0.00,'2018-02-14 09:03:46','2018-02-14 09:10:39','multileg',2,'No');`)

	// OrderLegs
	db.Exec(`INSERT INTO order_legs (id, user_id, created_at, updated_at, order_id, type, symbol_id, side, qty, status, duration, avg_fill_price, exec_quantity, last_fill_price, last_fill_quantity, remaining_quantity, create_date, transaction_date) VALUES
	(1,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',3,'credit',14,'buy_to_open',9,'filled','day',1.62,9.00,1.65,1.00,0.00,'2018-01-30 09:20:25','2018-01-30 09:45:11'),
	(2,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',3,'credit',15,'sell_to_open',9,'filled','day',1.86,9.00,1.89,1.00,0.00,'2018-01-30 09:20:25','2018-01-30 09:45:11'),
	(3,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',4,'credit',16,'buy_to_open',9,'filled','day',1.49,9.00,1.49,3.00,0.00,'2018-01-31 09:39:20','2018-01-31 11:21:38'),
	(4,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',4,'credit',17,'sell_to_open',9,'filled','day',1.73,9.00,1.73,9.00,0.00,'2018-01-31 09:39:20','2018-01-31 11:21:38'),
	(5,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',5,'debit',14,'sell_to_close',9,'filled','gtc',6.27,9.00,6.27,9.00,0.00,'2018-02-01 09:30:04','2018-02-05 11:57:31'),
	(6,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',5,'debit',15,'buy_to_close',9,'filled','gtc',6.99,9.00,6.99,9.00,0.00,'2018-02-01 09:30:04','2018-02-05 11:57:31'),
	(7,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',6,'credit',16,'buy_to_open',9,'filled','day',1.22,9.00,1.22,1.00,0.00,'2018-02-01 09:40:44','2018-02-01 10:42:33'),
	(8,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',6,'credit',17,'sell_to_open',9,'filled','day',1.43,9.00,1.43,9.00,0.00,'2018-02-01 09:40:44','2018-02-01 10:42:33'),
	(9,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',7,'debit',16,'sell_to_close',18,'filled','gtc',6.82,18.00,6.82,18.00,0.00,'2018-02-02 07:27:02','2018-02-05 11:58:57'),
	(10,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',7,'debit',17,'buy_to_close',18,'filled','gtc',7.51,18.00,7.51,18.00,0.00,'2018-02-02 07:27:02','2018-02-05 11:58:57'),
	(11,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',8,'credit',18,'buy_to_open',9,'filled','day',1.48,9.00,1.48,9.00,0.00,'2018-02-02 08:07:00','2018-02-02 08:19:15'),
	(12,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',8,'credit',19,'sell_to_open',9,'filled','day',1.71,9.00,1.71,9.00,0.00,'2018-02-02 08:07:00','2018-02-02 08:19:15'),
	(13,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',9,'credit',20,'buy_to_open',9,'filled','day',1.56,9.00,1.56,9.00,0.00,'2018-02-05 08:01:06','2018-02-05 08:17:18'),
	(14,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',9,'credit',21,'sell_to_open',9,'filled','day',1.81,9.00,1.81,9.00,0.00,'2018-02-05 08:01:06','2018-02-05 08:17:18'),
	(15,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',10,'credit',22,'buy_to_open',9,'filled','day',2.33,9.00,2.33,9.00,0.00,'2018-02-05 10:40:10','2018-02-05 11:26:06'),
	(16,1,'2018-02-17 00:13:53','2018-02-17 00:13:53',10,'credit',23,'sell_to_open',9,'filled','day',2.55,9.00,2.55,9.00,0.00,'2018-02-05 10:40:10','2018-02-05 11:26:06'),
	(17,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',11,'credit',24,'buy_to_open',9,'filled','day',2.56,9.00,4.55,1.00,0.00,'2018-02-05 12:11:47','2018-02-05 12:14:14'),
	(18,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',11,'credit',25,'sell_to_open',9,'filled','day',2.91,9.00,4.90,1.00,0.00,'2018-02-05 12:11:47','2018-02-05 12:14:14'),
	(19,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',13,'credit',26,'sell_to_open',2,'filled','day',6.35,2.00,6.35,2.00,0.00,'2018-02-06 09:39:06','2018-02-06 09:39:06'),
	(20,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',13,'credit',5,'buy_to_open',2,'filled','day',4.91,2.00,4.91,2.00,0.00,'2018-02-06 09:39:06','2018-02-06 09:39:06'),
	(21,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',14,'credit',27,'buy_to_open',9,'filled','day',3.28,9.00,3.28,9.00,0.00,'2018-02-08 09:53:10','2018-02-08 09:54:24'),
	(22,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',14,'credit',28,'sell_to_open',9,'filled','day',3.59,9.00,3.59,9.00,0.00,'2018-02-08 09:53:10','2018-02-08 09:54:24'),
	(23,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',15,'debit',27,'sell_to_close',9,'filled','gtc',0.14,9.00,0.14,4.00,0.00,'2018-02-08 10:09:37','2018-02-16 09:35:13'),
	(24,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',15,'debit',28,'buy_to_close',9,'filled','gtc',0.17,9.00,0.17,9.00,0.00,'2018-02-08 10:09:37','2018-02-16 09:35:13'),
	(25,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',17,'credit',29,'buy_to_open',9,'filled','day',2.26,9.00,2.26,9.00,0.00,'2018-02-09 09:06:50','2018-02-09 09:08:48'),
	(26,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',17,'credit',30,'sell_to_open',9,'filled','day',2.54,9.00,2.54,9.00,0.00,'2018-02-09 09:06:50','2018-02-09 09:08:48'),
	(27,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',19,'debit',29,'sell_to_close',9,'filled','gtc',0.10,9.00,0.10,9.00,0.00,'2018-02-12 09:09:44','2018-02-14 06:35:46'),
	(28,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',19,'debit',30,'buy_to_close',9,'filled','gtc',0.13,9.00,0.13,9.00,0.00,'2018-02-12 09:09:44','2018-02-14 06:35:46'),
	(29,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',20,'credit',31,'buy_to_open',9,'filled','day',2.17,9.00,2.17,9.00,0.00,'2018-02-14 09:03:46','2018-02-14 09:10:39'),
	(30,1,'2018-02-17 00:13:53','2018-02-17 00:13:54',20,'credit',32,'sell_to_open',9,'filled','day',2.46,9.00,2.46,9.00,0.00,'2018-02-14 09:03:46','2018-02-14 09:10:39');`)

	// Setup know test parms
	var userId uint = 1
	var class string = "multileg"
	var status string = "filled"
	var reviewed string = "No"

	// Make query.
	orders, err := db.GetOrdersByUserClassStatusReviewed(userId, class, status, reviewed)

	// Verify data returned
	st.Expect(t, err, nil)
	st.Expect(t, len(orders), 15)
	st.Expect(t, orders[4].Id, uint(9))
	st.Expect(t, len(orders[4].Legs), 2)
	st.Expect(t, orders[4].Legs[0].Id, uint(13))
	st.Expect(t, orders[4].Legs[1].Id, uint(14))
}

/* End File */
